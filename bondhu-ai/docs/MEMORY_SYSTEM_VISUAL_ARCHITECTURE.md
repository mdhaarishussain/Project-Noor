# ğŸ¨ Conversational Memory System - Visual Architecture

## ğŸ“Š System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                  USER                                        â”‚
â”‚                           (Chat Dashboard)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTP Request
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            FRONTEND (Next.js)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Enhanced Chat Component                                            â”‚    â”‚
â”‚  â”‚  â€¢ Loads chat history from /api/v1/chat/history                    â”‚    â”‚
â”‚  â”‚  â€¢ Sends messages to /api/v1/chat/send                             â”‚    â”‚
â”‚  â”‚  â€¢ Displays conversation with personality context badge            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ POST /api/v1/chat/send
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          BACKEND API (FastAPI)                               â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Chat Route Handler (/api/v1/chat/send)                             â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  1. Memory Extraction                                                â”‚  â”‚
â”‚  â”‚     â”œâ”€ MemoryExtractor.extract_memories(message)                    â”‚  â”‚
â”‚  â”‚     â””â”€ Store in: user_memories table                                â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  2. Memory Retrieval                                                 â”‚  â”‚
â”‚  â”‚     â”œâ”€ MemoryRetriever.retrieve_relevant_context()                  â”‚  â”‚
â”‚  â”‚     â”‚   â”œâ”€ Get user facts (favorite_anime, etc.)                    â”‚  â”‚
â”‚  â”‚     â”‚   â”œâ”€ Get recent conversations (last 7 days)                   â”‚  â”‚
â”‚  â”‚     â”‚   â””â”€ Detect references ("remember when...")                   â”‚  â”‚
â”‚  â”‚     â””â”€ Combine into comprehensive_context                           â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  3. Context Enrichment                                               â”‚  â”‚
â”‚  â”‚     â”œâ”€ Personality context (Big Five scores)                        â”‚  â”‚
â”‚  â”‚     â”œâ”€ User facts context                                           â”‚  â”‚
â”‚  â”‚     â”œâ”€ Conversation history context                                 â”‚  â”‚
â”‚  â”‚     â””â”€ Reference detection context                                  â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  4. LLM Generation                                                   â”‚  â”‚
â”‚  â”‚     â””â”€ Gemini.send_message(enriched_context + current_message)     â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚  5. Storage                                                          â”‚  â”‚
â”‚  â”‚     â”œâ”€ Store user message â†’ chat_messages                           â”‚  â”‚
â”‚  â”‚     â””â”€ Store AI response â†’ chat_messages                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MEMORY MANAGEMENT LAYER                                 â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MemoryExtractor     â”‚  â”‚  MemoryRetriever     â”‚  â”‚ ConversationMgr  â”‚ â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚  â€¢ Regex patterns    â”‚  â”‚  â€¢ Combine sources   â”‚  â”‚ â€¢ Summarize      â”‚ â”‚
â”‚  â”‚  â€¢ Extract facts     â”‚  â”‚  â€¢ Smart retrieval   â”‚  â”‚ â€¢ Store summariesâ”‚ â”‚
â”‚  â”‚  â€¢ Categorize        â”‚  â”‚  â€¢ Detect references â”‚  â”‚ â€¢ Index topics   â”‚ â”‚
â”‚  â”‚  â€¢ Set importance    â”‚  â”‚  â€¢ Build context     â”‚  â”‚ â€¢ Track emotions â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚             â”‚                        â”‚                        â”‚             â”‚
â”‚             â”‚                        â”‚                        â”‚             â”‚
â”‚             â–¼                        â–¼                        â–¼             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         MemoryService                               â”‚   â”‚
â”‚  â”‚  â€¢ add_memory()          â€¢ get_memories()                          â”‚   â”‚
â”‚  â”‚  â€¢ add_memories_batch()  â€¢ search_memories()                       â”‚   â”‚
â”‚  â”‚  â€¢ get_important_memories() â€¢ generate_session_context()           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SUPABASE DATABASE                                    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Table: user_memories                                                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  | user_id | key              | value         | importance | ... |  â”‚  â”‚
â”‚  â”‚  |---------|------------------|---------------|------------|-----|  â”‚  â”‚
â”‚  â”‚  | abc-123 | favorite_anime   | Re:Zero       | high       | ... |  â”‚  â”‚
â”‚  â”‚  | abc-123 | favorite_character| Natsuki      | high       | ... |  â”‚  â”‚
â”‚  â”‚  | abc-123 | occupation       | Engineer      | high       | ... |  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Table: conversation_memories                                        â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  | session_id | summary                    | topics    | emotions | â”‚  â”‚
â”‚  â”‚  |------------|----------------------------|-----------|----------|  â”‚  â”‚
â”‚  â”‚  | def-456    | Discussion about anime... | [anime]   | [happy]  |  â”‚  â”‚
â”‚  â”‚  | ghi-789    | Work stress conversation  | [work]    | [anxious]|  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Table: memory_index                                                 â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  | user_id | session_id | index_type | topic    | entity_name |    â”‚  â”‚
â”‚  â”‚  |---------|------------|------------|----------|-------------|    â”‚  â”‚
â”‚  â”‚  | abc-123 | def-456    | topic      | anime    | NULL        |    â”‚  â”‚
â”‚  â”‚  | abc-123 | def-456    | entity     | NULL     | Natsuki     |    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Table: chat_messages                                                â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚
â”‚  â”‚  | id  | user_id | message_text      | sender_type | session_id |  â”‚  â”‚
â”‚  â”‚  |-----|---------|-------------------|-------------|------------|  â”‚  â”‚
â”‚  â”‚  | m1  | abc-123 | My favorite anime...| user      | def-456    |  â”‚  â”‚
â”‚  â”‚  | m2  | abc-123 | That sounds great!  | ai        | def-456    |  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Memory Flow Sequence

### Scenario: User References Past Conversation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER   â”‚ "Remember that anime character I mentioned last time?"
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Message Arrives at Chat API                        â”‚
â”‚ â€¢ user_id: abc-123                                         â”‚
â”‚ â€¢ message: "Remember that anime character..."              â”‚
â”‚ â€¢ session_id: generated or provided                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Memory Extraction (MemoryExtractor)                â”‚
â”‚ â€¢ Scans message for facts: NONE found                      â”‚
â”‚ â€¢ (No new memories to extract from this message)           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Memory Retrieval (MemoryRetriever)                 â”‚
â”‚                                                             â”‚
â”‚ 3a. Detect Reference Phrase                                â”‚
â”‚     â”œâ”€ Found: "remember" âœ“                                 â”‚
â”‚     â”œâ”€ Found: "mentioned" âœ“                                â”‚
â”‚     â””â”€ Found: "last time" âœ“                                â”‚
â”‚                                                             â”‚
â”‚ 3b. Extract Topics from Message                            â”‚
â”‚     â””â”€ Detected: "anime", "character"                      â”‚
â”‚                                                             â”‚
â”‚ 3c. Search Memory Index                                    â”‚
â”‚     â”œâ”€ Query: topic = "anime"                              â”‚
â”‚     â”œâ”€ Found: 2 sessions with anime topic                  â”‚
â”‚     â””â”€ Retrieved: [def-456, ghi-789]                       â”‚
â”‚                                                             â”‚
â”‚ 3d. Get Conversation Memories                              â”‚
â”‚     â”œâ”€ Query: session_id IN [def-456, ghi-789]            â”‚
â”‚     â””â”€ Retrieved conversation summaries                    â”‚
â”‚                                                             â”‚
â”‚ 3e. Get User Facts                                         â”‚
â”‚     â”œâ”€ Query: user_memories WHERE key LIKE '%anime%'       â”‚
â”‚     â””â”€ Found: favorite_anime = "Re:Zero"                   â”‚
â”‚              favorite_character = "Natsuki Subaru"         â”‚
â”‚                                                             â”‚
â”‚ 3f. Build Comprehensive Context                            â”‚
â”‚     â”œâ”€ User Facts Section                                  â”‚
â”‚     â”œâ”€ Past Conversations Section                          â”‚
â”‚     â””â”€ Reference Detection Section                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Context Enrichment                                 â”‚
â”‚                                                             â”‚
â”‚ Combined Context:                                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                                             â”‚
â”‚ [PERSONALITY CONTEXT]                                       â”‚
â”‚ User's personality: Openness: 75, Conscientiousness: 82... â”‚
â”‚                                                             â”‚
â”‚ [USER FACTS]                                               â”‚
â”‚ Important things to remember:                              â”‚
â”‚ - Favorite Anime: Re:Zero                                  â”‚
â”‚ - Favorite Character: Natsuki Subaru                       â”‚
â”‚                                                             â”‚
â”‚ [PAST CONVERSATIONS]                                        â”‚
â”‚ 1. Conversation from October 5th at 2:30 PM:              â”‚
â”‚    Summary: User discussed favorite anime and characters   â”‚
â”‚    Topics: anime, entertainment                            â”‚
â”‚    Key Points:                                             â”‚
â”‚    â€¢ My favorite anime is Re:Zero                          â”‚
â”‚    â€¢ My favorite character is Natsuki Subaru              â”‚
â”‚                                                             â”‚
â”‚ [REFERENCE DETECTED]                                        â”‚
â”‚ User is referencing: "character I mentioned last time"     â”‚
â”‚ Use the conversation from October 5th to provide context   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: LLM Generation (Gemini)                            â”‚
â”‚                                                             â”‚
â”‚ Input to LLM:                                              â”‚
â”‚ â€¢ System Prompt: [Personality + Context above]            â”‚
â”‚ â€¢ User Message: "Remember that anime character..."         â”‚
â”‚                                                             â”‚
â”‚ LLM Processing:                                            â”‚
â”‚ â”œâ”€ Reads context about Re:Zero                            â”‚
â”‚ â”œâ”€ Sees Natsuki Subaru mentioned in past conversation     â”‚
â”‚ â””â”€ Generates response with continuity                      â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: Response Generated                                 â”‚
â”‚                                                             â”‚
â”‚ AI Response:                                               â”‚
â”‚ "Yes! You mentioned that your favorite character is        â”‚
â”‚  Natsuki Subaru from Re:Zero. He's known for his Return   â”‚
â”‚  by Death ability and determination. What would you like   â”‚
â”‚  to discuss about him?"                                    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: Storage                                            â”‚
â”‚                                                             â”‚
â”‚ Store in chat_messages:                                    â”‚
â”‚ â”œâ”€ User message (sender_type: user)                        â”‚
â”‚ â””â”€ AI response (sender_type: ai)                           â”‚
â”‚                                                             â”‚
â”‚ Both linked by: session_id                                 â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: Return Response to Frontend                        â”‚
â”‚                                                             â”‚
â”‚ JSON Response:                                             â”‚
â”‚ {                                                          â”‚
â”‚   "response": "Yes! You mentioned...",                     â”‚
â”‚   "has_personality_context": true,                         â”‚
â”‚   "timestamp": "2025-10-07T...",                           â”‚
â”‚   "message_id": "xyz-789"                                  â”‚
â”‚ }                                                          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USER   â”‚ Sees response with continuity! âœ“
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” Memory Retrieval Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MemoryRetriever Decision Tree                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Does message contain reference phrase?
â”œâ”€ YES: "remember", "last time", "you said", etc.
â”‚   â”‚
â”‚   â”œâ”€ Extract topics from message
â”‚   â”‚   â”œâ”€ Search memory_index for matching topics
â”‚   â”‚   â””â”€ Get conversation_memories for found sessions
â”‚   â”‚
â”‚   â”œâ”€ Search user_memories for related facts
â”‚   â”‚
â”‚   â””â”€ Build REFERENCE DETECTION context
â”‚       â”œâ”€ "User is referencing past conversation"
â”‚       â”œâ”€ Include relevant conversation summaries
â”‚       â””â”€ Include related user facts
â”‚
â””â”€ NO: Normal message
    â”‚
    â”œâ”€ Get recent conversations (last 7 days)
    â”‚   â””â”€ Limit to 3 most recent
    â”‚
    â”œâ”€ Get important user facts
    â”‚   â””â”€ Prioritize high-importance memories
    â”‚
    â””â”€ Build GENERAL context
        â”œâ”€ User facts section
        â””â”€ Recent conversations section

Result: Comprehensive context for LLM
```

## ğŸ“Š Data Flow Diagram

```
USER MESSAGE
     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                          â”‚
     â–¼                          â–¼
[Extract Facts]          [Retrieve Context]
     â”‚                          â”‚
     â”‚                          â”œâ”€ Get user_memories
     â”‚                          â”œâ”€ Get conversation_memories
     â”‚                          â””â”€ Get memory_index
     â”‚                          â”‚
     â–¼                          â–¼
[user_memories]          [Build Context String]
     â”‚                          â”‚
     â”‚                          â–¼
     â”‚                    [Personality Context]
     â”‚                          +
     â”‚                    [User Facts Context]
     â”‚                          +
     â”‚                    [Conversation Context]
     â”‚                          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
           [LLM Prompt]
                â”‚
                â”œâ”€ System: enriched_context
                â””â”€ User: current_message
                â”‚
                â–¼
           [Gemini LLM]
                â”‚
                â–¼
           [AI Response]
                â”‚
                â”œâ”€ Store user message
                â”œâ”€ Store AI response
                â”‚
                â–¼
          [chat_messages]
                â”‚
                â””â”€ (Background)
                   Periodic Summarization
                        â”‚
                        â–¼
                   [conversation_memories]
                        +
                   [memory_index]
```

## ğŸ¯ Memory Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Memory Lifecycle                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Phase 1: EXTRACTION (Real-time)
â”œâ”€ User sends message
â”œâ”€ MemoryExtractor scans for facts
â”œâ”€ Facts stored in user_memories
â””â”€ Importance level assigned

Phase 2: STORAGE (Real-time)
â”œâ”€ Message stored in chat_messages
â”œâ”€ Session ID links conversation
â””â”€ Metadata captured (mood, sentiment)

Phase 3: RETRIEVAL (Real-time)
â”œâ”€ Next message arrives
â”œâ”€ MemoryRetriever finds relevant context
â”‚   â”œâ”€ User facts (user_memories)
â”‚   â”œâ”€ Past conversations (conversation_memories)
â”‚   â””â”€ Topic index (memory_index)
â””â”€ Context injected into LLM prompt

Phase 4: SUMMARIZATION (Background/Periodic)
â”œâ”€ Session ends or reaches N messages
â”œâ”€ ConversationMemoryManager analyzes session
â”‚   â”œâ”€ Generates conversation summary
â”‚   â”œâ”€ Extracts topics discussed
â”‚   â”œâ”€ Identifies emotions
â”‚   â””â”€ Captures key points
â”œâ”€ Stored in conversation_memories
â””â”€ Topics indexed in memory_index

Phase 5: LONG-TERM RETRIEVAL (Ongoing)
â”œâ”€ User references past conversations
â”œâ”€ System searches by:
â”‚   â”œâ”€ Topic (fast lookup via memory_index)
â”‚   â”œâ”€ Time range (recent conversations)
â”‚   â””â”€ Text search (full-text on summaries)
â””â”€ Relevant memories returned
```

## ğŸ” Security & Access Control

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Row Level Security (RLS)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Every Query:
â”œâ”€ Supabase intercepts query
â”œâ”€ Checks auth.uid() from JWT token
â”œâ”€ Applies RLS policy:
â”‚   â””â”€ WHERE user_id = auth.uid()
â””â”€ Only returns user's own data

Example:
User abc-123 queries: SELECT * FROM conversation_memories

Supabase executes:
SELECT * FROM conversation_memories 
WHERE user_id = 'abc-123'  -- Enforced by RLS

User abc-123 CANNOT see user xyz-456's memories!

Tables Protected:
âœ“ user_memories
âœ“ conversation_memories
âœ“ memory_index
âœ“ chat_messages
```

## ğŸ“ˆ Performance Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Index Strategy                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Fast Queries Enabled by Indexes:

1. User-based lookups
   Index: (user_id, start_time DESC)
   Query: Get recent conversations for user
   Speed: O(log n) instead of O(n)

2. Topic search
   Index: GIN(topics) - array containment
   Query: Find conversations about "work"
   Speed: Instant lookup via inverted index

3. Full-text search
   Index: GIN(to_tsvector(summary))
   Query: Search summaries by keywords
   Speed: Optimized for text search

4. Time-range queries
   Index: (user_id, start_time, end_time)
   Query: Conversations in date range
   Speed: Range scan on indexed columns

Result: Sub-100ms query times even with 1000+ conversations
```

---

**Status**: Visual documentation complete  
**Purpose**: Help developers understand the system at a glance  
**Date**: October 7, 2025
